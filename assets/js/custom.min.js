"use strict";var drawTable,drawCalc,PRODUCTS=[{id:"ad99",label:"Ад 99,99"},{id:"adsi92",label:"АдСи 92,5"}],DIMENTIONS=[{id:"length",label:"м"},{id:"weight",label:"гр"}];WIDTH_WEIGHTS=[{width:.5,weight:2.06},{width:.6,weight:2.96},{width:.7,weight:4.03},{width:.8,weight:5.27},{width:.9,weight:6.67},{width:1,weight:8.24},{width:1.1,weight:9.97},{width:1.2,weight:11.86},{width:1.3,weight:13.93},{width:1.4,weight:16.16},{width:1.5,weight:18.55},{width:1.6,weight:21.1},{width:1.7,weight:23.82},{width:1.8,weight:26.71},{width:1.9,weight:29.75},{width:2,weight:32.97},{width:2.1,weight:36.35},{width:2.2,weight:39.89},{width:2.3,weight:43.6},{width:2.4,weight:47.48},{width:2.5,weight:51.52}];var PRICES=[{width:.5,price:70},{width:.75,price:70},{width:1.1,price:70},{width:1/0,price:65}],RESTRICTIONS={width:{min:.5,max:2},weight:{min:1,max:1e4},length:{min:.01,max:100}},MIN_ORDER_WEIGHT=100,Order={items:[],addItem:function(){this.items.push({product:null,width:null,length:null,weight:null,dimention:"length"})},removeItem:function(e){this.items.splice(Number(e),1),this.items.length<1&&this.addItem()},total:function(){var e=this.items.reduce(function(e,t){var n=PRICES.find(function(e){return t.width<e.width});return e+(t.width&&n?n.price:0)*(("weight"===t.dimention?t.weight:100*t.length)||0)},0);return Math.round(100*e)/100},weightList:function(){var t=this;return PRODUCTS.map(function(n){var e=t.items.reduce(function(e,t){return t.product!==n.id?e:e+("weight"===t.dimention?t.weight||0:100*(t.length||0))},0);return{product:n.label,weight:e}}).filter(function(e){return e.weight})},totalWeight:function(){var e=this.weightList().reduce(function(e,t){return e+t.weight},0);return Math.round(100*e)/100},isValid:function(){return this.items.reduce(function(e,i){var t=["product","width",i.dimention].reduce(function(e,t){var n=!RESTRICTIONS[t]||i[t]>=RESTRICTIONS[t].min&&i[t]<=RESTRICTIONS[t].max;return e&&n&&Boolean(i[t])},!0);return e&&t},!0)}};function createTableTdNode(e){var t=document.createElement("div");return t.classList.add("calc-table__td"),t.appendChild(e),t}function createSelectNode(e){var t=e.placeholder,n=e.options,i=e.data,r=e.key,a=e.onChange,o=i[r],c=document.createElement("select"),d=$(c);if(c.classList.add("select","select_base"),!n.find(function(e){return e.id===o})&&t){var l=document.createElement("option");l.classList.add("select_base__option"),l.setAttribute("disabled",""),l.setAttribute("selected",""),l.innerText=t,c.appendChild(l)}return n.forEach(function(e){var t=document.createElement("option");t.classList.add("select_base__option"),t.innerText=e.label,t.dataset.id=e.id,o===e.id&&t.setAttribute("selected",""),c.appendChild(t)}),d.on("change",function(e){var t=d.find("option:selected");if(t){var n=i[r];i[r]=t.data("id"),n!==i[r]&&a()}}),c}function createInputNode(e){var t=e.placeholder,n=e.data,i=void 0===n?{}:n,r=e.key,a=e.min,o=void 0===a?0:a,c=e.max,d=void 0===c?1/0:c,l=e.step,s=void 0===l?.05:l,u=e.onChange,h=void 0===u?function(){}:u,m=document.createElement("div");m.classList.add("input_base");var w=document.createElement("input"),p=$(w);return w.setAttribute("type","number"),w.setAttribute("min",o),w.setAttribute("max",d),w.setAttribute("step",s),w.setAttribute("placeholder",t),w.classList.add("input_base__input"),w.value=i[r],p.on("change",function(e){if("null"!==t){var t=Number(w.value),n=Math.max(Math.min(t,d),o);w.value=n,i[r]=n,o<=n&&n<=d?w.classList.remove("input_base__input--error"):w.classList.add("input_base__input--error"),h()}}),m.appendChild(w),m}$(document).ready(function(){var e=document.querySelectorAll(".js-input-number-mask"),t=document.querySelectorAll(".js-input-phone-mask");e.forEach(function(e){IMask(e,{mask:Number})}),t.forEach(function(e){IMask(e,{mask:"+{7}(000)000-00-00"})});function n(e){var t=document.querySelector(".calc");e?t.classList.add("-show-form"):t.classList.remove("-show-form")}var i=document.querySelector(".calc-table__tbody"),r=document.querySelector(".js-add-row-button"),a=document.querySelector(".js-checkout-button"),o=document.querySelector(".js-cancel-button"),c=document.querySelector(".js-calc-result-header"),d=document.querySelector(".js-price-list"),l=($(i),$(c)),s=$(d),u=$("form[name=calc-form]"),h=$(".order-form-submit"),m=$(".alert-send-success"),w=$(".alert-send-error");a.addEventListener("click",function(){Order.isValid()&&n(!0)}),o.addEventListener("click",function(){return n(!1)}),i.addEventListener("click",function(e){e.stopPropagation();var t=e.target.closest(".js-remove-row-button"),n=e.target.closest(".calc-table__tr");t&&(Order.removeItem(n.dataset.id),drawTable(),drawCalc())}),r.addEventListener("click",function(){Order.addItem(),drawTable()}),h.on("click",function(e){e.preventDefault(),p(u)}),drawTable=function(){var e=Order.items.map(function(e,t){return createRowNode({id:t,item:e})});$(i).html(e)},drawCalc=function(){l.text("Итог: ".concat(Order.total()," р.")),s.empty(),s.append(Order.weightList().map(createPriceListItemNode))};var p=function(e){var t,n,i,r=e.serializeArray(),a={};return r.forEach(function(e){var t=e.name,n=e.value;return a[t]=n}),t=a,n="button_base--disabled",(i=$("order-form-submit")).addClass(n),$.ajax({method:"POST",url:"/index.php?rest_route=/beta/v1/orders",contentType:"application/json",data:JSON.stringify({name:t.name,phone:t.phone,email:t.email,items:Order.items})}).then(function(e){if(i.removeClass(n),e.errors)return e.errors}).catch(function(e){throw i.removeClass(n),e}).then(function(e){if(e)return f(e);g()}).catch(function(){f()})},f=function(){w.addClass("-active")},g=function(){n(!1),m.addClass("-active")};Order.addItem(),drawTable(),drawCalc()}),"NodeList"in window&&!NodeList.prototype.forEach&&(console.info("polyfill for IE11"),NodeList.prototype.forEach=function(e,t){t=t||window;for(var n=0;n<this.length;n++)e.call(t,this[n],n,this)}),Element.prototype.closest||(Element.prototype.closest=function(e){for(var t=this;t;){if(t.matches(e))return t;t=t.parentElement}return null}),Element.prototype.matches||(Element.prototype.matches=Element.prototype.matchesSelector||Element.prototype.webkitMatchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector),Array.from||(Array.from=function(e){return[].slice.call(e)});var createButtonNode=function(){var e=document.createElement("button");return e.classList.add("calc-table__button","js-remove-row-button"),e.innerHTML='\n    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 492 492" style="enable-background:new 0 0 492 492;" xml:space="preserve"><path d="M300.188,246L484.14,62.04c5.06-5.064,7.852-11.82,7.86-19.024c0-7.208-2.792-13.972-7.86-19.028L468.02,7.872\n        c-5.068-5.076-11.824-7.856-19.036-7.856c-7.2,0-13.956,2.78-19.024,7.856L246.008,191.82L62.048,7.872\n        c-5.06-5.076-11.82-7.856-19.028-7.856c-7.2,0-13.96,2.78-19.02,7.856L7.872,23.988c-10.496,10.496-10.496,27.568,0,38.052\n        L191.828,246L7.872,429.952c-5.064,5.072-7.852,11.828-7.852,19.032c0,7.204,2.788,13.96,7.852,19.028l16.124,16.116\n        c5.06,5.072,11.824,7.856,19.02,7.856c7.208,0,13.968-2.784,19.028-7.856l183.96-183.952l183.952,183.952\n        c5.068,5.072,11.824,7.856,19.024,7.856h0.008c7.204,0,13.96-2.784,19.028-7.856l16.12-16.116\n        c5.06-5.064,7.852-11.824,7.852-19.028c0-7.204-2.792-13.96-7.852-19.028L300.188,246z"/>\n      </svg>\n    ',e};function createPriceListItemNode(e){var t=e.product,n=e.weight,i=document.createElement("span");return i.classList.add("calc-result-price"),i.textContent="".concat(t,": ").concat(n," гр."),i}function createRowNode(e){var t=e.id,n=e.item,i=document.createElement("div"),r=createSelectNode({placeholder:"Марка",options:PRODUCTS,data:n,key:"product",onChange:function(){drawTable(),drawCalc()}}),a=createInputNode({placeholder:"Толщина",data:n,key:"width",min:RESTRICTIONS.width.min,max:RESTRICTIONS.width.max,onChange:function(){drawCalc()}}),o=createInputNode({placeholder:"Длина",data:n,key:"length",min:RESTRICTIONS.length.min,max:RESTRICTIONS.length.max,onChange:function(){drawCalc()}}),c=createInputNode({placeholder:"Вес",data:n,key:"weight",min:RESTRICTIONS.weight.min,max:RESTRICTIONS.weight.max,onChange:function(){drawCalc()}}),d=createSelectNode({placeholder:"ед. изм",options:DIMENTIONS,data:n,key:"dimention",onChange:function(){drawTable(),drawCalc()}}),l=createButtonNode();i.dataset.id=t;var s=[r,a,"length"===n.dimention?o:c,d];return i.classList.add("calc-table__tr"),s.forEach(function(e){return i.appendChild(createTableTdNode(e))}),i.appendChild(l),i}