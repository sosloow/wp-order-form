"use strict";var drawTable,drawCalc,sendSuccess,sendFail,resetAlerts,PRODUCTS=[{id:"ag99",label:"Ag 99,99",density:.0105,prices:[{width:.5,price:80},{width:.75,price:75},{width:1.1,price:70},{width:1/0,price:65}]},{id:"agcu925",label:"AgCu 92,5",density:.01038,prices:[{width:.5,price:80},{width:.75,price:75},{width:1.1,price:70},{width:1/0,price:65}]}],DIMENTIONS=[{id:"length",label:"м"},{id:"weight",label:"гр"}],RESTRICTIONS={width:{min:.3,max:2.5},weight:{min:1,max:1e4},length:{min:.01,max:1e3}},MIN_ORDER_WEIGHT=100,CLASS_DISABLED="button_base--disabled",Order={items:[],addItem:function(){this.items.push({product:null,width:null,length:null,weight:null,dimention:"length"})},removeItem:function(e){this.items.splice(Number(e),1),this.items.length<1&&this.addItem()},total:function(){var e=this.items.reduce(function(e,t){var n=PRODUCTS.find(function(e){return e.id===t.product});if(!n)return e;var r=n.prices.find(function(e){return t.width<e.width});return e+(t.width&&r?r.price:0)*(("weight"===t.dimention?t.weight:t.length*widthWeight(t))||0)},0);return Math.round(100*e)/100},weightList:function(){var t=this;return PRODUCTS.map(function(n){var e=t.listValid().reduce(function(e,t){return t.product!==n.id?e:e+("weight"===t.dimention?t.weight||0:(t.length||0)*widthWeight(t))},0);return{product:n.label,weight:e}}).filter(function(e){return e.weight})},totalWeight:function(){var e=this.weightList().reduce(function(e,t){return e+t.weight},0);return Math.round(100*e)/100},listValid:function(){return this.items.filter(function(n){return["product","width",n.dimention].reduce(function(e,t){return e&&Boolean(n[t])},!0)})},isValid:function(){var e=0<this.total(),t=100<=this.totalWeight();return e&&t}};function widthWeight(e){var t=e.product,n=e.width,r=PRODUCTS.find(function(e){return e.id===t});if(!r)return 0;var i=r.density,a=3.14*Math.pow(n/2,2)*1e3*i;return Math.round(100*a)/100}function createTableTdNode(e){var t=document.createElement("div");return t.classList.add("calc-table__td"),t.appendChild(e),t}function createSelectNode(e){var t=e.placeholder,n=e.options,r=e.data,i=e.key,a=e.onChange,c=r[i],o=document.createElement("select"),d=$(o);if(o.classList.add("select","select_base"),!n.find(function(e){return e.id===c})&&t){var l=document.createElement("option");l.classList.add("select_base__option"),l.setAttribute("disabled",""),l.setAttribute("selected",""),l.innerText=t,o.appendChild(l)}return n.forEach(function(e){var t=document.createElement("option");t.classList.add("select_base__option"),t.innerText=e.label,t.dataset.id=e.id,c===e.id&&t.setAttribute("selected",""),o.appendChild(t)}),d.on("change",function(e){var t=d.find("option:selected");if(t){var n=r[i];r[i]=t.data("id"),n!==r[i]&&a()}}),o}function createInputNode(e){var t=e.placeholder,n=e.data,r=void 0===n?{}:n,i=e.key,a=e.min,c=void 0===a?0:a,o=e.max,d=void 0===o?1/0:o,l=e.step,s=void 0===l?.05:l,u=e.onChange,h=void 0===u?function(){}:u,m=document.createElement("div");m.classList.add("input_base");var p=document.createElement("input"),f=$(p);return p.setAttribute("type","number"),p.setAttribute("min",c),p.setAttribute("max",d),p.setAttribute("step",s),p.setAttribute("placeholder",t),p.classList.add("input_base__input"),p.value=r[i],f.on("change",function(e){if("null"!==t){var t=Number(p.value),n=Math.max(Math.min(t,d),c);p.value=n,r[i]=n,c<=n&&n<=d?p.classList.remove("input_base__input--error"):p.classList.add("input_base__input--error"),h()}}),m.appendChild(p),m}$(document).ready(function(){function e(e){var t=document.querySelector(".calc");e?t.classList.add("-show-form"):t.classList.remove("-show-form")}document.querySelectorAll(".js-input-number-mask"),document.querySelectorAll(".js-input-phone-mask");var t=document.querySelector(".calc-table__tbody"),n=document.querySelector(".js-add-row-button"),r=document.querySelector(".js-checkout-button"),i=document.querySelector(".js-cancel-button"),a=document.querySelector(".js-calc-result-header"),c=document.querySelector(".js-price-list"),o=($(t),$(a)),d=$(c),l=$("form[name=calc-form]"),s=$(".order-form-submit"),u=$(".alert-send-success"),h=$(".alert-send-error");r.addEventListener("click",function(){Order.isValid()&&e(!0)}),i.addEventListener("click",function(){return e(!1)}),t.addEventListener("click",function(e){e.stopPropagation();var t=e.target.closest(".js-remove-row-button"),n=e.target.closest(".calc-table__tr");t&&(Order.removeItem(n.dataset.id),drawTable(),drawCalc())}),n.addEventListener("click",function(){Order.addItem(),drawTable(),drawCalc()}),s.on("click",function(e){e.preventDefault(),m(l)}),l.on("change",function(){l.find("input[required]").toArray().reduce(function(e,t){return e&&Boolean(t.value)},!0)?s.removeClass(CLASS_DISABLED):s.addClass(CLASS_DISABLED)}),drawTable=function(){var e=Order.items.map(function(e,t){return createRowNode({id:t,item:e})});$(t).html(e)},drawCalc=function(){o.text("Итог: ".concat(Order.total()," р.")),d.empty(),d.append(Order.weightList().map(createPriceListItemNode)),resetAlerts(),Order.isValid()?r.classList.remove(CLASS_DISABLED):r.classList.add(CLASS_DISABLED)};var m=function(e){var t,n,r=e.serializeArray(),i={};return r.forEach(function(e){var t=e.name,n=e.value;return i[t]=n}),t=i,(n=$("order-form-submit")).addClass(CLASS_DISABLED),$.ajax({method:"POST",url:"/index.php?rest_route=/beta/v1/orders",contentType:"application/json",data:JSON.stringify({name:t.name,phone:t.phone,email:t.email,items:Order.listValid()})}).then(function(e){if(n.removeClass(CLASS_DISABLED),e.errors)return e.errors}).catch(function(e){throw n.removeClass(CLASS_DISABLED),e}).then(function(e){if(e)return sendFail(e);sendSuccess()}).catch(function(){sendFail()})};sendFail=function(){h.addClass("-active")},sendSuccess=function(){e(!1),u.addClass("-active")},resetAlerts=function(){h.removeClass("-active"),u.removeClass("-active")},Order.addItem(),drawTable(),drawCalc()}),"NodeList"in window&&!NodeList.prototype.forEach&&(console.info("polyfill for IE11"),NodeList.prototype.forEach=function(e,t){t=t||window;for(var n=0;n<this.length;n++)e.call(t,this[n],n,this)}),Element.prototype.closest||(Element.prototype.closest=function(e){for(var t=this;t;){if(t.matches(e))return t;t=t.parentElement}return null}),Element.prototype.matches||(Element.prototype.matches=Element.prototype.matchesSelector||Element.prototype.webkitMatchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector),Array.from||(Array.from=function(e){return[].slice.call(e)});var createButtonNode=function(){var e=document.createElement("button");return e.classList.add("calc-table__button","js-remove-row-button"),e.innerHTML='\n    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 492 492" style="enable-background:new 0 0 492 492;" xml:space="preserve"><path d="M300.188,246L484.14,62.04c5.06-5.064,7.852-11.82,7.86-19.024c0-7.208-2.792-13.972-7.86-19.028L468.02,7.872\n        c-5.068-5.076-11.824-7.856-19.036-7.856c-7.2,0-13.956,2.78-19.024,7.856L246.008,191.82L62.048,7.872\n        c-5.06-5.076-11.82-7.856-19.028-7.856c-7.2,0-13.96,2.78-19.02,7.856L7.872,23.988c-10.496,10.496-10.496,27.568,0,38.052\n        L191.828,246L7.872,429.952c-5.064,5.072-7.852,11.828-7.852,19.032c0,7.204,2.788,13.96,7.852,19.028l16.124,16.116\n        c5.06,5.072,11.824,7.856,19.02,7.856c7.208,0,13.968-2.784,19.028-7.856l183.96-183.952l183.952,183.952\n        c5.068,5.072,11.824,7.856,19.024,7.856h0.008c7.204,0,13.96-2.784,19.028-7.856l16.12-16.116\n        c5.06-5.064,7.852-11.824,7.852-19.028c0-7.204-2.792-13.96-7.852-19.028L300.188,246z"/>\n      </svg>\n    ',e};function createPriceListItemNode(e){var t=e.product,n=e.weight,r=document.createElement("span");return r.classList.add("calc-result-price"),r.textContent="".concat(t,": ").concat(n," гр."),r}function createRowNode(e){var t=e.id,n=e.item,r=document.createElement("div"),i=createSelectNode({placeholder:"Марка",options:PRODUCTS,data:n,key:"product",onChange:function(){drawTable(),drawCalc()}}),a=createInputNode({placeholder:"Диаметр",data:n,key:"width",min:RESTRICTIONS.width.min,max:RESTRICTIONS.width.max,onChange:function(){drawCalc()}}),c=createInputNode({placeholder:"Длина",data:n,key:"length",min:RESTRICTIONS.length.min,max:RESTRICTIONS.length.max,onChange:function(){n.weight=(n.length||0)*widthWeight(n),drawCalc()}}),o=createInputNode({placeholder:"Вес",data:n,key:"weight",min:RESTRICTIONS.weight.min,max:RESTRICTIONS.weight.max,onChange:function(){drawCalc()}}),d=createSelectNode({placeholder:"ед. изм",options:DIMENTIONS,data:n,key:"dimention",onChange:function(){n.length=null,n.weight=null,drawTable(),drawCalc()}}),l=createButtonNode();r.dataset.id=t;var s=[i,a,"length"===n.dimention?c:o,d];return r.classList.add("calc-table__tr"),s.forEach(function(e){return r.appendChild(createTableTdNode(e))}),r.appendChild(l),r}