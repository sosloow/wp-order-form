"use strict";var drawTable,drawCalc,PRODUCTS=[{id:"ag99",label:"Ad 99,99",density:.0105},{id:"agcu92",label:"AgCu 92,5",density:.01038}],DIMENTIONS=[{id:"length",label:"м"},{id:"weight",label:"гр"}],PRICES=[{width:.5,price:70},{width:.75,price:70},{width:1.1,price:70},{width:1/0,price:65}],RESTRICTIONS={width:{min:.5,max:2},weight:{min:1,max:1e4},length:{min:.01,max:100}},MIN_ORDER_WEIGHT=100,Order={items:[],addItem:function(){this.items.push({product:null,width:null,length:null,weight:null,dimention:"length"})},removeItem:function(e){this.items.splice(Number(e),1),this.items.length<1&&this.addItem()},total:function(){var e=this.items.reduce(function(e,t){var n=PRICES.find(function(e){return t.width<e.width});return e+(t.width&&n?n.price:0)*(("weight"===t.dimention?t.weight:t.length*widthWeight(t))||0)},0);return Math.round(100*e)/100},weightList:function(){var t=this;return PRODUCTS.map(function(n){var e=t.items.reduce(function(e,t){return t.product!==n.id?e:e+("weight"===t.dimention?t.weight||0:(t.length||0)*widthWeight(t))},0);return{product:n.label,weight:e}}).filter(function(e){return e.weight})},totalWeight:function(){var e=this.weightList().reduce(function(e,t){return e+t.weight},0);return Math.round(100*e)/100},isValid:function(){return this.items.reduce(function(e,r){var t=["product","width",r.dimention].reduce(function(e,t){var n=!RESTRICTIONS[t]||r[t]>=RESTRICTIONS[t].min&&r[t]<=RESTRICTIONS[t].max;return e&&n&&Boolean(r[t])},!0);return e&&t},!0)}};function widthWeight(e){var t=e.product,n=e.width,r=PRODUCTS.find(function(e){return e.id===t});if(!r)return 0;var a=r.density,i=3.14*Math.pow(n/2,2)*1e3*a;return Math.round(100*i)/100}function createTableTdNode(e){var t=document.createElement("div");return t.classList.add("calc-table__td"),t.appendChild(e),t}function createSelectNode(e){var t=e.placeholder,n=e.options,r=e.data,a=e.key,i=e.onChange,o=r[a],c=document.createElement("select"),d=$(c);if(c.classList.add("select","select_base"),!n.find(function(e){return e.id===o})&&t){var l=document.createElement("option");l.classList.add("select_base__option"),l.setAttribute("disabled",""),l.setAttribute("selected",""),l.innerText=t,c.appendChild(l)}return n.forEach(function(e){var t=document.createElement("option");t.classList.add("select_base__option"),t.innerText=e.label,t.dataset.id=e.id,o===e.id&&t.setAttribute("selected",""),c.appendChild(t)}),d.on("change",function(e){var t=d.find("option:selected");if(t){var n=r[a];r[a]=t.data("id"),n!==r[a]&&i()}}),c}function createInputNode(e){var t=e.placeholder,n=e.data,r=void 0===n?{}:n,a=e.key,i=e.min,o=void 0===i?0:i,c=e.max,d=void 0===c?1/0:c,l=e.step,u=void 0===l?.05:l,s=e.onChange,m=void 0===s?function(){}:s,h=document.createElement("div");h.classList.add("input_base");var p=document.createElement("input"),f=$(p);return p.setAttribute("type","number"),p.setAttribute("min",o),p.setAttribute("max",d),p.setAttribute("step",u),p.setAttribute("placeholder",t),p.classList.add("input_base__input"),p.value=r[a],f.on("change",function(e){if("null"!==t){var t=Number(p.value),n=Math.max(Math.min(t,d),o);p.value=n,r[a]=n,o<=n&&n<=d?p.classList.remove("input_base__input--error"):p.classList.add("input_base__input--error"),m()}}),h.appendChild(p),h}$(document).ready(function(){var e=document.querySelectorAll(".js-input-number-mask"),t=document.querySelectorAll(".js-input-phone-mask");e.forEach(function(e){IMask(e,{mask:Number})}),t.forEach(function(e){IMask(e,{mask:"+{7}(000)000-00-00"})});function n(e){var t=document.querySelector(".calc");e?t.classList.add("-show-form"):t.classList.remove("-show-form")}var r=document.querySelector(".calc-table__tbody"),a=document.querySelector(".js-add-row-button"),i=document.querySelector(".js-checkout-button"),o=document.querySelector(".js-cancel-button"),c=document.querySelector(".js-calc-result-header"),d=document.querySelector(".js-price-list"),l=($(r),$(c)),u=$(d),s=$("form[name=calc-form]"),m=$(".order-form-submit"),h=$(".alert-send-success"),p=$(".alert-send-error");i.addEventListener("click",function(){Order.isValid()&&n(!0)}),o.addEventListener("click",function(){return n(!1)}),r.addEventListener("click",function(e){e.stopPropagation();var t=e.target.closest(".js-remove-row-button"),n=e.target.closest(".calc-table__tr");t&&(Order.removeItem(n.dataset.id),drawTable(),drawCalc())}),a.addEventListener("click",function(){Order.addItem(),drawTable()}),m.on("click",function(e){e.preventDefault(),f(s)}),drawTable=function(){var e=Order.items.map(function(e,t){return createRowNode({id:t,item:e})});$(r).html(e)},drawCalc=function(){l.text("Итог: ".concat(Order.total()," р.")),u.empty(),u.append(Order.weightList().map(createPriceListItemNode))};var f=function(e){var t,n,r,a=e.serializeArray(),i={};return a.forEach(function(e){var t=e.name,n=e.value;return i[t]=n}),t=i,n="button_base--disabled",(r=$("order-form-submit")).addClass(n),$.ajax({method:"POST",url:"/index.php?rest_route=/beta/v1/orders",contentType:"application/json",data:JSON.stringify({name:t.name,phone:t.phone,email:t.email,items:Order.items})}).then(function(e){if(r.removeClass(n),e.errors)return e.errors}).catch(function(e){throw r.removeClass(n),e}).then(function(e){if(e)return w(e);v()}).catch(function(){w()})},w=function(){p.addClass("-active")},v=function(){n(!1),h.addClass("-active")};Order.addItem(),drawTable(),drawCalc()}),"NodeList"in window&&!NodeList.prototype.forEach&&(console.info("polyfill for IE11"),NodeList.prototype.forEach=function(e,t){t=t||window;for(var n=0;n<this.length;n++)e.call(t,this[n],n,this)}),Element.prototype.closest||(Element.prototype.closest=function(e){for(var t=this;t;){if(t.matches(e))return t;t=t.parentElement}return null}),Element.prototype.matches||(Element.prototype.matches=Element.prototype.matchesSelector||Element.prototype.webkitMatchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector),Array.from||(Array.from=function(e){return[].slice.call(e)});var createButtonNode=function(){var e=document.createElement("button");return e.classList.add("calc-table__button","js-remove-row-button"),e.innerHTML='\n    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 492 492" style="enable-background:new 0 0 492 492;" xml:space="preserve"><path d="M300.188,246L484.14,62.04c5.06-5.064,7.852-11.82,7.86-19.024c0-7.208-2.792-13.972-7.86-19.028L468.02,7.872\n        c-5.068-5.076-11.824-7.856-19.036-7.856c-7.2,0-13.956,2.78-19.024,7.856L246.008,191.82L62.048,7.872\n        c-5.06-5.076-11.82-7.856-19.028-7.856c-7.2,0-13.96,2.78-19.02,7.856L7.872,23.988c-10.496,10.496-10.496,27.568,0,38.052\n        L191.828,246L7.872,429.952c-5.064,5.072-7.852,11.828-7.852,19.032c0,7.204,2.788,13.96,7.852,19.028l16.124,16.116\n        c5.06,5.072,11.824,7.856,19.02,7.856c7.208,0,13.968-2.784,19.028-7.856l183.96-183.952l183.952,183.952\n        c5.068,5.072,11.824,7.856,19.024,7.856h0.008c7.204,0,13.96-2.784,19.028-7.856l16.12-16.116\n        c5.06-5.064,7.852-11.824,7.852-19.028c0-7.204-2.792-13.96-7.852-19.028L300.188,246z"/>\n      </svg>\n    ',e};function createPriceListItemNode(e){var t=e.product,n=e.weight,r=document.createElement("span");return r.classList.add("calc-result-price"),r.textContent="".concat(t,": ").concat(n," гр."),r}function createRowNode(e){var t=e.id,n=e.item,r=document.createElement("div"),a=createSelectNode({placeholder:"Марка",options:PRODUCTS,data:n,key:"product",onChange:function(){drawTable(),drawCalc()}}),i=createInputNode({placeholder:"Толщина",data:n,key:"width",min:RESTRICTIONS.width.min,max:RESTRICTIONS.width.max,onChange:function(){drawCalc()}}),o=createInputNode({placeholder:"Длина",data:n,key:"length",min:RESTRICTIONS.length.min,max:RESTRICTIONS.length.max,onChange:function(){n.weight=(n.length||0)*widthWeight(n),console.log(n),drawCalc()}}),c=createInputNode({placeholder:"Вес",data:n,key:"weight",min:RESTRICTIONS.weight.min,max:RESTRICTIONS.weight.max,onChange:function(){drawCalc()}}),d=createSelectNode({placeholder:"ед. изм",options:DIMENTIONS,data:n,key:"dimention",onChange:function(){n.length=null,n.weight=null,drawTable(),drawCalc()}}),l=createButtonNode();r.dataset.id=t;var u=[a,i,"length"===n.dimention?o:c,d];return r.classList.add("calc-table__tr"),u.forEach(function(e){return r.appendChild(createTableTdNode(e))}),r.appendChild(l),r}